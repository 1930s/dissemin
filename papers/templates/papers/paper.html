{% extends "dissemin/details.html" %}

{% load author %}
{% load domain %}
{% load statuses %}
{% load doi %}
{% load i18n %}

{% block metaTags %}
    <meta name="citation_title" content="{{ paper.title }}" />
    {% for author in paper.sorted_authors %}
        <meta name="citation_author" content="{{ author.name.last }}, {{ author.name.first }}" />
        {% if author.affiliation %}
        <meta name="citation_author_institution" content="{{ author.affiliation }}" />
        {% endif %}
    {% endfor %}
    <meta name="citation_publication_date" content="{{ paper.year }}" />
    {% if paper.pdf_url %}
        <meta name="citation_pdf_url" content="{{ paper.pdf_url }}" />
    {% endif %}
{% endblock %}

{% block headTitle %}
{{ paper.title }}
{% endblock %}

{% block bodyTitle %}
<span id="paperTitle" data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" data-pk="{{ paper.pk }}">
    {% autoescape off %}
        {{ paper.title }}
    {% endautoescape %}
</span>
{% endblock %}

{% block jsScript %}
{% if request.user.is_authenticated %}
$(function(){

    function paperMerged(domElem, response) {
        window.location.replace('/paper/'+response.merged);
    }

    makeTextEditable($('#paperTitle'), '/ajax/change-paper', 'title', paperMerged);
    $(".unknownAuthorName").each(function(index) {
        makeAuthorEditable($(this), paperMerged);
    });
});
{% endif %}
{% endblock %}

{% block lists %}
<p>
{% for author in paper.sorted_authors %}{% if not forloop.first %},{% endif %}
<span><span class="{% if author.researcher_id %}knownAuthorName{% else %}unknownAuthorName{% endif %}"
    data-pk="{{ author.pk }}"
    data-first="{{ author.name.first }}"
    data-last="{{ author.name.last }}"
    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}">{{ author | authorlink }}</span></span>{% endfor %}</p>


{% if paper.can_be_asked_to_upload%}
<p><span><a href="{% url 'mail_paper' paper.pk %}" class="btn btn-default btn-xs">{% trans "Ask upload" %}</a></span></p> 
{% endif %}

{% for publi in paper.publication_set.all %}
<p>{{ publi | publication }}
{% if publi.doi %}
(DOI: <a href="{{ publi | doi_to_url }}">{{ publi.doi }}</a>)
{% endif %}
</p>
{% endfor %}

<p><strong>{% trans "Full text:" %}</strong>
    {% if paper.pdf_url %}<a href="{{ paper.pdf_url }}">{% trans "Available" %} <img src="/static/extpdf.png"/></a>
    {% else %}{% trans "Unavailable" %}{% endif %}</p>

    {% for publi in paper.publications_with_unique_publisher %}
        {% with publi.publisher as psh %}
            <p><strong>{% trans "Publisher:" %}</strong>
            <a href="{% url 'publisher' psh.pk %}">{{ psh }}</a></p>
            <p><strong>{% trans "Policy:" %}</strong> {{ psh.oa_status | explain_oa_status }}
            (<a href="{% url 'publisher' psh.pk %}">{% trans "details" %}</a>)</p>
        {% endwith %}
    {% endfor %}

{% for record in paper.oairecord_set.all %}
{% if forloop.first %}
    {% if record.description %}
        <p><strong>{% trans "Abstract." %}</strong></p>
		<div class="abstract">{{ record.description }}</div>
    {% endif %}
{% endif %}
{% endfor %}
{% endblock %}

{% block details %}
<span class="detailsTitle">{% trans "Available from" %}</span>
<div class="detailsContent">
{% for record in paper.sorted_oai_records %}
<p>
    {% if record.priority > 0 %}
        {{ record.source }}:
    {% else %}
        {% if record.splash_url %}
            [{{ record.splash_url |domain }}]
        {% elif record.pdf_url %}
            [{{ record.pdf_url |domain }}]
        {% endif %}
    {% endif %}
    {% if record.splash_url %}
        <a href="{{ record.splash_url }}">
     [{% trans "Web page" %} <img src="/static/extlink.png" />]
     </a>{% if record.pdf_url %} | {% endif %}{% endif %}
     {% if record.pdf_url %}
         <a href="{{ record.pdf_url }}"><img src="/static/extpdf.png" alt="PDF" /></a>
     {% endif %}
</p>
{% endfor %}

{% trans "Publisher" as publisher %}
{% for publi in paper.publication_set.all %}
<p><a href="{{ publi | doi_to_url }}">{{ publi.publisher|default:publisher }} <img src="/static/extlink.png" /></a> {% trans "via DOI" %}</p>
{% endfor %}
</div>

{% if request.user.is_superuser %}
<span class="detailsTitle">{% trans "Admin zone" %}</span>
<div class="detailsContent">
    <p><strong>Visibility:</strong> {{ paper.visibility }}</p>
    <p><strong>Publisher:</strong> {{ paper.publisher }}</p>
    <p><strong>Clusters:</strong></p>
{% for a in paper.author_set.all %}
<p>{{a}}: 
{% if a.cluster %}
<a href="{% url 'paper' a.cluster.paper.pk %}">{{ a.cluster.paper }}</a>
({{a.cluster.num_children}} authors, score {{a.cluster.cluster_relevance}})
{% else %}
itself
{% endif %}
</p>
{% endfor %}
<p><strong>Annotations:</strong>
<ul>
{% for annot in paper.annotation_set.all %}
    <li>{{ annot }}</li>
{% empty %}
None
{% endfor %}
</ul>
</p>
</div>
{% endif %}
{% endblock %}
