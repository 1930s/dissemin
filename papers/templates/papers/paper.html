{% extends "dissemin/details.html" %}

{% load author %}
{% load domain %}
{% load statuses %}
{% load doi %}
{% load i18n %}

{% block metaTags %}
    <meta name="citation_title" content="{{ paper.title }}" />
    {% for author in paper.sorted_authors %}
        <meta name="citation_author" content="{{ author.name.last }}, {{ author.name.first }}" />
        {% if author.affiliation %}
        <meta name="citation_author_institution" content="{{ author.affiliation }}" />
        {% endif %}
    {% endfor %}
    <meta name="citation_publication_date" content="{{ paper.year }}" />
    {% if paper.pdf_url %}
        <meta name="citation_pdf_url" content="{{ paper.pdf_url }}" />
    {% endif %}
{% endblock %}

{% block headTitle %}
{{ paper.title }}
{% endblock %}

{% block bodyTitle %}
<h1 id="paperTitle" data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" data-pk="{{ paper.pk }}">
    {% autoescape off %}
        {{ paper.title }}
    {% endautoescape %}
</h1>
{% endblock %}

{% block jsScript %}
{% if request.user.is_authenticated %}
$(function(){

    function paperMerged(domElem, response) {
        window.location.replace('/paper/'+response.merged);
    }

    makeTextEditable($('#paperTitle'), '/ajax/change-paper', 'title', paperMerged);
    $(".unknownAuthorName").each(function(index) {
        makeAuthorEditable($(this), paperMerged);
    });
    $('.annotate-paper-radio').change(function(){
        console.log($(this));
        var value = $(this).val();
        $.ajax({url:'/ajax/'+$(this).attr('name')+'-'+value})
    });
});

{% endif %}
{% if paper.has_many_authors %}
$(function(){
    var summary = $('#authorSummary').clone();
    var full = $('#authorFull').detach();
    var setup_links = function(){
    $('#show_all_authors').click(function(){
        $('#authorSummary').replaceWith(full);
        setup_links();
      });
    $('#show_less_authors').click(function(){
        $('#authorFull').replaceWith(summary);
        setup_links();
     });
    };
    setup_links();
});
{% endif %}
{% endblock %}

{% block lists %}
<p id="paperAuthors">
{% if paper.has_many_authors %}
    <div id="authorSummary">
        {% include "papers/authorList.html" with author_list=paper.interesting_authors %}
         {% with paper.nb_remaining_authors as nb_remaining_authors %}
            {% blocktrans %}
            and <a href="#" id="show_all_authors">{{ nb_remaining_authors }} other authors</a>
            {% endblocktrans %}
        {% endwith %}
    </div>
    <div id="authorFull">
        {% with paper.author_count as nb_authors %}
            {% blocktrans %}
            All {{ nb_authors }} authors (<a href="#" id="show_less_authors">show less</a>):<br />
            {% endblocktrans %}
        {% endwith %}

        {% include "papers/authorList.html" with author_list=paper.sorted_authors %}
    </div>
{% else %}
    {% include "papers/authorList.html" with author_list=paper.sorted_authors %}
{% endif %}
</p>

<div id="paperAvailability">

<div id="paperAvailabilityLogo">
{% if paper.pdf_url %}<a href="{{ paper.pdf_url }}"><img src="/static/symbol-PDF-{{ paper.oa_status }}.png" width="52" height="70" /></a>
    {% else %}<img src="/static/symbol-{{ paper.oa_status }}.png" width="52" height="70" />{% endif %}
</div>

<div id="paperDetails">
<p><strong>{% trans "Full text:" %}</strong>
    {% if paper.pdf_url %}<a href="{{ paper.pdf_url }}">{% trans "Available" %} <img src="/static/extpdf.png"/></a>
    {% else %}
	  {% trans "Unavailable" %}
	  {% if paper.can_be_asked_for_upload and request.user.is_authenticated %}
        <span><a href="{% url 'mail_paper' paper.pk %}" class="btn btn-default btn-xs">{% trans "Ask upload" %}</a></span>
{% endif %}
    {% endif %}</p>

    {% for publi in paper.publications_with_unique_publisher %}
        {% with publi.publisher as psh %}
            <p><strong>{% trans "Publisher:" %}</strong>
            <a href="{% url 'publisher' psh.pk %}">{{ psh }}</a></p>
            <p><strong>{% trans "Policy:" %}</strong> {{ psh.oa_status | explain_oa_status }}
            (<a href="{% url 'publisher' psh.pk %}">{% trans "details" %}</a>)</p>
        {% endwith %}
    {% endfor %}
</div>

</div>

{% for record in paper.oairecord_set.all %}
{% if forloop.first %}
    {% if record.description %}
        <span class="detailsTitle">{% trans "Abstract" %}</span>
		<div class="detailsContent"><div class="abstract">{{ record.description }}</div></div>
    {% endif %}
{% endif %}
{% endfor %}

{% endblock %}


{% block details %}

{% for publi in paper.publication_set.all %}
{% if forloop.first %}
  <span class="detailsTitle">{% trans "Published in" %}</span>
  <div class="detailsContent">
{% endif %}
<p>{{ publi | publication }}
{% if publi.doi %}
(DOI: <a href="{{ publi | doi_to_url }}">{{ publi.doi }}</a>)
{% endif %}
</p>
{% if forloop.last %}
</div>
{% endif %}
{% endfor %}

<span class="detailsTitle">{% trans "Data from" %}</span>
<div class="detailsContent">
{% for record in paper.sorted_oai_records %}
<p>
    {% if record.splash_url %}
        <a href="{{ record.splash_url }}">
	{% endif %}
    {% if record.priority > 0 %}
        {{ record.source }}
    {% else %}
        {% if record.splash_url %}
            [{{ record.splash_url |domain }}]
        {% elif record.pdf_url %}
            [{{ record.pdf_url |domain }}]
        {% endif %}
    {% endif %}
    {% if record.splash_url %}<img src="/static/extlink.png" /></a>{% if record.pdf_url %} | {% endif %}
	{% endif %}
    {% if record.pdf_url %}
        <a href="{{ record.pdf_url }}"><img src="/static/extpdf.png" alt="PDF" /></a>
    {% endif %}
</p>
{% endfor %}

{% trans "Publisher" as publisher %}
{% for publi in paper.publication_set.all %}
<p><a href="{{ publi | doi_to_url }}">{{ publi.publisher|default:publisher }} <img src="/static/extlink.png" /></a> {% trans "via DOI" %}</p>
{% endfor %}
</div>

<span class="detailsTitle">{% trans "Departments" %}</span>
<div class="detailsContent">
{% for dept in view.departments %}
<p><a href="{% url 'department' dept.id %}">{{ dept }}</a></p>
{% endfor %}

{% if request.user.is_authenticated %}
    {% include "papers/annotButtons.html" with paper=paper with_scholar=1 %}
{% endif %}

</div>

<span class="detailsTitle">{% trans "Tools" %}</span>
<div class="detailsContent">
    <p><a href="{{ paper.google_scholar_link }}">{% trans "Search in Google Scholar" %}</a></p>
    <p><a href="{{ paper.core_link }}">{% trans "Search in CORE" %}</a></p>
</div>

{% if request.user.is_superuser %}
<span class="detailsTitle">{% trans "Admin zone" %}</span>
<div class="detailsContent">
    <p><strong>Visibility:</strong> {{ paper.visibility }}</p>
    <p><strong>Publisher:</strong> {{ paper.publisher }}</p>
    <p><strong>Clusters:</strong></p>
{% for a in paper.author_set.all %}
<p>{{a}}: 
{% if a.cluster %}
<a href="{% url 'paper' a.cluster.paper.pk %}">{{ a.cluster.paper }}</a>
({{a.cluster.num_children}} authors, score {{a.cluster.cluster_relevance}})
{% else %}
itself
{% endif %}
</p>
{% endfor %}
<p><strong>Annotations:</strong>
<ul>
{% for annot in paper.annotation_set.all %}
    <li>{{ annot }}</li>
{% empty %}
None
{% endfor %}
</ul>
</p>
</div>
{% endif %}
{% endblock %}
