{% extends "dissemin/details.html" %}

{% load author %}
{% load domain %}
{% load statuses %}
{% load doi %}
{% load i18n %}
{% load static %}

{% block headTitle %}
{% trans "Depositing" %} "{{ paper.title }}"
{% endblock %}

{% block bodyTitle %}
{% trans "Depositing" %} "{{ paper.title }}"
{% endblock %}

{% block extra_head %}
    <script src="{% static "libs/jquery.ui.widget.js" %}"></script>
    <script src="{% static "libs/jquery.iframe-transport.js" %}"></script>
    <script src="{% static "libs/jquery.fileupload.js" %}"></script>
{% endblock %}

{% block jsScript %}

   

$(function(){

    var resultDiv = $('#uploadedResult');
    var uploadForm = $('#uploadForm');

    function addFileWidget(name, size) {
        var tpl = $('<div class="uploadFileItem uploadWorking"><div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%"></div></div><p></p><span></span></div>');

        // Append the file name and file size
        tpl.find('p').text(name)
        var formattedSize = 'Uploading...';
        if(size > 0) {
            formattedSize = formatFileSize(size);
        }
        tpl.append('<i>' + formattedSize + '</i>');

        // Add the HTML to the UL element
        resultDiv.empty();
        return tpl.appendTo(resultDiv);
    }

    function removeBar() {
        var progressDiv = $('.progress');
        progressDiv.fadeOut(function(){
            progressDiv.remove();
        });
    }

    function updateProgress(tpl, progress) {
        var progressBar = $('.progress-bar');
        progressBar.css('width', progress+'%').attr('aria-valuenow', progress);
    }

    function uploadComplete(tpl) {
        tpl.removeClass('uploadWorking');
        var uploadInputs = $('#uploadInputs');
        uploadInputs.fadeOut(function(){
            uploadInputs.remove();
        });
        removeBar();
    }

    function displayErrorMessage(tpl, msg) {
        tpl.find('i').text(msg);
        tpl.addClass('uploadError');
        removeBar();
    }


    $('#browseButton').click(function(){
        // Simulate a click on the file input button
        // to show the file browser dialog
        $(this).parent().parent().find('input').click();
    });

    // Initialize the jQuery File Upload plugin
    uploadForm.fileupload({

        // This element will accept file drag/drop uploading
        dropZone: $('#dropZone'),

        // This function is called when a file is added to the queue;
        // either via the browse button, or via drag/drop:
        add: function (e, data) {
            console.log('starting upload');

            data.context = addFileWidget(data.files[0].name, data.files[0].size);

           // Listen for clicks on the cancel icon
            data.context.find('span').click(function(){

                if(data.context.hasClass('working')){
                    jqXHR.abort();
                }

                data.context.fadeOut(function(){
                    data.context.remove();
                });

            });

            // Automatically upload the file once it is added to the queue
            var jqXHR = data.submit();
        },

        progress: function(e, data){
            // Calculate the completion percentage of the upload
            var progress = parseInt(data.loaded / data.total * 100, 10);

            updateProgress(data.context, progress);
        },

        done: function(e, data) {
            uploadComplete(data.context);
        },

        fail:function(e, data){
            resp = data.jqXHR.responseJSON
            if('upl' in resp) {
                displayErrorMessage(data.context, resp['upl']);
            } else {
                $('#globalError').text(data.jqXHR.responseText);
            }
        }
    });

    // Prevent the default action when a file is dropped on the window
    $(document).on('drop dragover', function (e) {
        e.preventDefault();
    });

    // Helper function that formats the file sizes
    function formatFileSize(bytes) {
        if (typeof bytes !== 'number') {
            return '';
        }

        if (bytes >= 1000000000) {
            return (bytes / 1000000000).toFixed(2) + ' GB';
        }

        if (bytes >= 1000000) {
            return (bytes / 1000000).toFixed(2) + ' MB';
        }

        return (bytes / 1000).toFixed(2) + ' KB';
    }


    /* Panels */
    $('#optionUploadType').collapse({
        parent:$('#uploadOptions'),
        toggle:false,
        }).on('show.bs.collapse', function () {
        $('#uploadTypeInline').empty();
    }).on('hidden.bs.collapse', function () {
        var selected = $("input[type='radio'][name='radioUploadType']:checked");
        if(selected.length > 0) {
            $('#uploadTypeInline').append($('#hiddenInline-'+selected.val()).clone());      
        }
    });
    $("input[type='radio'][name='radioUploadType']").click(function(){
        $('#optionUploadType').collapse('hide');
    });
    {% if request.GET.type %}
        $('#optionUploadType').collapse('hide');
    {% endif %}

    function uploadUrl() {
        var data = $('#urlForm').serialize();
        console.log(data);
        $('#addResearcherForm .formErrorDiv').each(function () {
            $(this).text('');
            });
        
        var tpl = addFileWidget($('#uploadUrl').val(),0);

        updateProgress(tpl, 10);
       $.post('{% url 'ajax-downloadUrl' %}', data, null, 'json').fail(function(data) {
                console.log(data);
                if(!data.responseJSON)
                {
                    $('#globalError').text(data.responseText);
                }
                else
                {
                    var resp = data.responseJSON;
                    displayErrorMessage(tpl, resp['message']);
                    // error = data.responseJSON;
                    // for(field in error) {
                    //    $('#error-'+field).text(error[field]);
                    //}

                }
            }).done(function(data) {
                console.log(data);
                if(data['status'] == 'error') {
                    $('#globalError').text(data['message']);
                }
                if(data['status'] == 'success') {
                    tpl.find('i').text(formatFileSize(data['size']));
                    updateProgress(tpl, 100);
                    uploadComplete(tpl);
                }
        });
    }

    $('#submitUploadUrl').click(uploadUrl);
});


{% endblock %}

{% block lists %}
{% if success %}
    <p>Papecr successfully uploaded!</p>
    <p>Thank you so much, you are awesome!</p>
    <p>Really, I mean it!</p>
    <p><a href="{% url 'paper' paper.pk %}">Back to the paper</a></p>
{% else %}
{% if failed %}
<p>Upload failed.</p>
{% endif %}

<div id="uploadIntro">
    <p>
        {% blocktrans %}
            You can deposit the full text of your article. Dissemin will
            send it to a repostory where it will be made freely available.
            Please ensure that you are one of the authors of this paper or
            that you have the permission to upload it on their behalf.
        {% endblocktrans %}
    </p>
</div>

<span class="detailsTitle">{% trans "Document" %}</span>
<div class="detailsContent">
    <div id="uploadInputs">
        <div class="uploadModeBrowse">
            <form id="uploadForm" method="post" action="{% url 'ajax-uploadFulltext' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <label for="upl">{% trans "Select a file:" %}</label>
                <p><a class="btn btn-success" id="browseButton">{% trans "Browse" %}</a><input type="file" name="upl" style="display:none" /></p>
            </form>
        </div>
        <div class="uploadModeUrl">

            <form id="urlForm" method="post" action="javascript:uploadUrl();">
                {% csrf_token %}
                <label for="url">{% trans "Enter an URL:" %}</label>
                <div>
                    <button type="submit" id="submitUploadUrl" class="btn btn-success"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></button>
                    <div class="urlContainer">
                        <input id="uploadUrl" type="text" class="form-control" name="url" placeholder="http://"/>
                    </div>
                </div>
            </form>
        </div>
        <div class="uploadModeDrop">
            <div id="dropZone">
            <p>{% trans "Drop a file here" %}</p>
            </div>
        </div>
        <p>{% trans "PDF files only, maximum size:" %} {{ max_file_size|filesizeformat }}.</p>
        <div id="globalError"></div>
    </div>
    <div id="uploadedResult"></div>
</div>

<span class="detailsTitle">{% trans "Options" %}</span>
<div id="uploadOptions" class="panel-group detailsContent" role="tablist" aria-multiselectable="true">
    <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingUploadType">
            <a role="button" data-toggle="collapse" data-parent="#uploadOptions"
                href="#optionUploadType">{% trans "Upload type:" %}</span><span id="uploadTypeInline"></a>
        </div>
        <div id="optionUploadType" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingUploadType">
            <div class="panel-body">
                {% include "publishers/detailsPolicy.html" with publisher=paper.publisher mode="radio" %}
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingRepository">
            <span>
                <a role="button" data-toggle="collapse"
                  data-parent="#uploadOptions" href="#optionRepository" aria-expanded="true"
                                                                        aria-controls="optionRepository">{% trans "Repository:" %} <strong>Zenodo</strong></a>
            </span>
        </div>
        <div id="optionRepository" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingRepository">
            <div class="panel-body">
                {% trans "Zenodo is currently the only supported repository." %}
            </div>
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingMetadata">
            <span>
                 <a role="button" data-toggle="collapse"
                  data-parent="#uploadOptions" href="#optionMetadata" aria-expanded="true"
                  aria-controls="optionMetadata">{% trans "Review metadata" %}</a>
            </span>
        </div>
        <div id="optionMetadata" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingMetadata">
            <div class="panel-body">
                {% trans "Coming soon." %}
            </div>
        </div>
    </div>
</div>

<div id="uploadSubmitSection">
    <p class="submitDeposit"><a id="submitDeposit" class="btn btn-lg btn-primary">{% trans "Deposit" %}</a></p>
    <p>
        {% blocktrans %}
            By depositing your article to Zenodo through Dissemin, you agree to the terms of use of
            both services.
        {% endblocktrans %}
    </p>
</div>
{% endif %}
{% endblock %}

{% block details %}
<span class="detailsTitle">{% trans "Data from" %}</span>
<div class="detailsContent">
{% for record in paper.sorted_oai_records %}
<p>
    {% if record.priority > 0 %}
        {{ record.source }}:
    {% else %}
        {% if record.splash_url %}
            [{{ record.splash_url |domain }}]
        {% elif record.pdf_url %}
            [{{ record.pdf_url |domain }}]
        {% endif %}
    {% endif %}
    {% if record.splash_url %}
        <a href="{{ record.splash_url }}">
     [{% trans "Web page" %} <img src="/static/extlink.png" />]
     </a>{% if record.pdf_url %} | {% endif %}{% endif %}
     {% if record.pdf_url %}
         <a href="{{ record.pdf_url }}"><img src="/static/extpdf.png" alt="PDF" /></a>
     {% endif %}
</p>
{% endfor %}

{% trans "Publisher" as publisher %}
{% for publi in paper.publication_set.all %}
<p><a href="{{ publi | doi_to_url }}">{{ publi.publisher|default:publisher }} <img src="/static/extlink.png" /></a> {% trans "via DOI" %}</p>
{% endfor %}
</div>

{% endblock %}
